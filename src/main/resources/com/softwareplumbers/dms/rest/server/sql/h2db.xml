<?xml version = "1.0" encoding = "UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
        xmlns:context="http://www.springframework.org/schema/context"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
 	http://www.springframework.org/schema/beans
	http://www.springframework.org/schema/beans/spring-beans-4.3.xsd
       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.3.xsd
       http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.3.xsd" xmlns:aop="http://www.springframework.org/schema/aop">
    
    <context:annotation-config />
    
    <bean class="com.softwareplumbers.dms.rest.server.sql.Schema">
        
        <property name="DropScript" >
            <value>
                DROP VIEW IF EXISTS VIEW_FOLDERS;
                DROP VIEW IF EXISTS VIEW_LINKS;
                DROP VIEW IF EXISTS LATEST_DOCUMENTS;
                DROP TABLE IF EXISTS FOLDERS;
                DROP TABLE IF EXISTS DOCUMENTS;
                DROP TABLE IF EXISTS LINKS;
                DROP TABLE IF EXISTS NODES;
            </value>
        </property>
        
        <property name="CreateScript">
            <value>
                CREATE TABLE NODES (
                    ID UUID PRIMARY KEY,
                    PARENT_ID UUID,
                    NAME VARCHAR(255),
                    TYPE VARCHAR(16),
                    DELETED BOOLEAN DEFAULT FALSE
                );

                CREATE TABLE LINKS (
                    ID UUID PRIMARY KEY,
                    DOCUMENT_ID UUID,
                    DOCUMENT_VERSION UUID,
                    VERSIONED BOOLEAN
                );

                CREATE TABLE DOCUMENTS (
                    ID UUID,
                    VERSION UUID PRIMARY KEY,
                    MEDIA_TYPE VARCHAR(255),
                    LENGTH BIGINT,
                    DIGEST BINARY(32),
                    CREATED TIMESTAMP,
                    METADATA CLOB
                );

                CREATE TABLE FOLDERS (
                    ID UUID PRIMARY KEY,
                    STATE VARCHAR(16),
                    METADATA CLOB
                );

                CREATE VIEW LATEST_DOCUMENTS AS SELECT
                    D1.ID AS ID,
                    D1.VERSION AS VERSION,
                    D1.MEDIA_TYPE AS MEDIA_TYPE,
                    D1.LENGTH AS LENGTH,
                    D1.DIGEST AS DIGEST,
                    D1.CREATED AS CREATED,
                    D1.METADATA AS METADATA
                FROM
                    DOCUMENTS D1
                WHERE
                    D1.CREATED = (
                        SELECT 
                            MAX(CREATED) 
                        FROM 
                            DOCUMENTS D2
                        WHERE
                            D1.ID = D2.ID             
                    );
            </value>
        </property>
        
        <property name="UpdateScript">
            <value>           
                CREATE OR REPLACE VIEW VIEW_LINKS AS SELECT
                    NODES.ID AS ID,
                    NODES.PARENT_ID AS PARENT_ID,
                    NODES.NAME AS NAME,
                    NODES.DELETED AS DELETED,
                    LINKS.VERSIONED AS VERSIONED,
                    DOCUMENTS.ID AS DOCUMENT_ID,
                    DOCUMENTS.VERSION AS DOCUMENT_VERSION,
                    DOCUMENTS.MEDIA_TYPE AS MEDIA_TYPE,
                    DOCUMENTS.LENGTH AS LENGTH,
                    DOCUMENTS.DIGEST AS DIGEST,
                    DOCUMENTS.CREATED AS DOCUMENT_CREATED,
                    DOCUMENTS.METADATA AS METADATA
                FROM
                    NODES 
                INNER JOIN
                    LINKS ON (NODES.ID = LINKS.ID)
                INNER JOIN
                    DOCUMENTS ON (LINKS.DOCUMENT_VERSION = DOCUMENTS.VERSION)
                WHERE
                    LINKS.VERSIONED = TRUE
                UNION ALL SELECT
                    NODES.ID AS ID,
                    NODES.PARENT_ID AS PARENT_ID,
                    NODES.NAME AS NAME,
                    NODES.DELETED AS DELETED,
                    LINKS.VERSIONED AS VERSIONED,
                    LATEST_DOCUMENTS.ID AS DOCUMENT_ID,
                    LATEST_DOCUMENTS.VERSION AS DOCUMENT_VERSION,
                    LATEST_DOCUMENTS.MEDIA_TYPE AS MEDIA_TYPE,
                    LATEST_DOCUMENTS.LENGTH AS LENGTH,
                    LATEST_DOCUMENTS.DIGEST AS DIGEST,
                    LATEST_DOCUMENTS.CREATED AS DOCUMENT_CREATED,
                    LATEST_DOCUMENTS.METADATA AS METADATA
                FROM
                    NODES 
                INNER JOIN
                    LINKS ON (NODES.ID = LINKS.ID)
                INNER JOIN
                    LATEST_DOCUMENTS ON (LINKS.DOCUMENT_ID = LATEST_DOCUMENTS.ID)
                WHERE
                    LINKS.VERSIONED = FALSE
                ;

                CREATE OR REPLACE VIEW VIEW_FOLDERS AS SELECT
                    NODES.ID AS ID,
                    NODES.PARENT_ID AS PARENT_ID,
                    NODES.NAME AS NAME,
                    NODES.DELETED AS DELETED,
                    FOLDERS.STATE AS STATE,
                    FOLDERS.METADATA AS METADATA
                FROM
                    NODES 
                INNER JOIN
                    FOLDERS ON (NODES.ID = FOLDERS.ID)         
                ;   
            </value>
        </property>

    </bean>
    
    <bean class="com.softwareplumbers.dms.rest.server.sql.Operations" scope="singleton">
        
        <property name="FetchPathToId">
            <value>
                WITH LINK(ID,NAME) AS (
                    SELECT ID,NAME 
                    FROM NODES 
                    WHERE PARENT_ID IS NULL 
                    UNION ALL SELECT 
                        NODES.ID, 
                        IFNULL(LINK.NAME || '/', '') || NODES.NAME 
                    FROM LINK 
                    INNER JOIN NODES ON LINK.ID = NODES.PARENT_ID
                ) 
                SELECT NAME FROM LINK WHERE ID = ?
            </value>
        </property>
        
        <property name="FetchLastNameLike" value="SELECT MAX(NAME) FROM NODES WHERE ID=? AND NAME LIKE ?"/>
        <property name="FetchInfoByName" value="SELECT ID, PARENT_ID, NAME, TYPE, DELETED FROM NODES WHERE PARENT_ID=? AND NAME = ?"/>

        <property name="FetchLinkByName">
            <value>
                SELECT 
                    ID, 
                    PARENT_ID,
                    NAME,
                    DELETED, 
                    VERSIONED, 
                    DOCUMENT_ID, 
                    DOCUMENT_VERSION,
                    DOCUMENT_CREATED,
                    MEDIA_TYPE,
                    LENGTH,
                    DIGEST,
                    METADATA,
                    NAME AS PATH,
                FROM
                    VIEW_LINKS
                WHERE
                    PARENT_ID = ?
                AND
                    NAME = ?
            </value>
        </property>
        <property name="FetchLinkById">
            <value>
                SELECT 
                    ID, 
                    PARENT_ID,
                    NAME,
                    DELETED, 
                    VERSIONED, 
                    DOCUMENT_ID, 
                    DOCUMENT_VERSION,
                    DOCUMENT_CREATED,
                    MEDIA_TYPE,
                    LENGTH,
                    DIGEST,
                    METADATA
                FROM
                    VIEW_LINKS
                WHERE
                    DOCUMENT_ID = ?
            </value>
        </property>        
        <property name="FetchFolderByName">
            <value>
                SELECT 
                    ID, 
                    PARENT_ID,
                    NAME,
                    DELETED, 
                    STATE,
                    METADATA,
                    NAME AS PATH
                FROM
                    VIEW_FOLDERS
                WHERE
                    PARENT_ID = ?
                AND
                    NAME = ?
            </value>
        </property>
        <property name="FetchLatestDocument">
            <value>
                SELECT 
                    ID, 
                    VERSION,
                    CREATED,
                    MEDIA_TYPE,
                    LENGTH,
                    DIGEST,
                    METADATA
                FROM
                    LATEST_DOCUMENTS
                WHERE
                    ID = ?
            </value>
        </property>
        <property name="FetchDocument">
            <value>
                SELECT 
                    ID, 
                    VERSION,
                    CREATED,
                    MEDIA_TYPE,
                    LENGTH,
                    DIGEST,
                    METADATA
                FROM
                    DOCUMENTS
                WHERE
                    ID = ?
                AND VERSION = ?
            </value>
        </property>
        <property name="CreateDocument">
            <value>
                INSERT INTO DOCUMENTS 
                    (ID, VERSION, MEDIA_TYPE, LENGTH, DIGEST, METADATA, CREATED) 
                VALUES (?,?,?,?,?,?, CURRENT_TIMESTAMP)
            </value>
        </property>
        
        <property name="CreateNode">
            <value>
                INSERT INTO NODES (ID, PARENT_ID, NAME, TYPE, DELETED) VALUES (?,?,?,?,FALSE) 
            </value>
        </property>
        
        <property name="CreateFolder">
            <value>
                INSERT INTO FOLDERS (ID, STATE, METADATA) VALUES (?,?,?)
            </value>
        </property>
        
        <property name="CopyFolder">
            <value>
                INSERT INTO FOLDERS (ID, STATE, METADATA) 
                SELECT ?, STATE, METADATA
                FROM FOLDERS
                WHERE ID = ?
            </value>
        </property>
        
        <property name="CreateLink">
            <value>
                INSERT INTO LINKS (ID, DOCUMENT_ID, DOCUMENT_VERSION, VERSIONED) VALUES (?,?,?,?)
            </value>
        </property>
        
        <property name="CopyLink">
            <value>
                INSERT INTO LINKS (ID, DOCUMENT_ID, DOCUMENT_VERSION, VERSIONED) 
                SELECT ?, DOCUMENT_ID, DOCUMENT_VERSION, VERSIONED
                FROM LINKS
                WHERE ID = ?                
            </value>
        </property>
        
        <property name="UpdateLink">
            <value>
                UPDATE LINKS SET DOCUMENT_ID=?, DOCUMENT_VERSION=?, VERSIONED=? WHERE LINKS.ID=?
            </value>
        </property>
        
        <property name="UpdateFolder">
            <value>
                UPDATE FOLDERS SET STATE=?, METADATA=? WHERE FOLDERS.ID=?
            </value>
        </property>
        
        <property name="FetchChildren">
            <value>
                SELECT 
                    ID, 
                    PARENT_ID,
                    NAME,
                    DELETED, 
                    TYPE,
                    NAME AS PATH
                FROM
                    NODES
                WHERE PARENT_ID = ?
            </value>
        </property>
        
        <property name="DeleteObject">
            <value>
                UPDATE NODES SET DELETED=TRUE WHERE PARENT_ID=? AND NAME=?
            </value>
        </property>
        
        <property name="DeleteDocumentById">
            <value>
                UPDATE NODES SET DELETED=TRUE 
                WHERE PARENT_ID=? 
                AND EXISTS (
                    SELECT ID FROM LINKS 
                    WHERE LINKS.ID = NODES.ID AND LINKS.DOCUMENT_ID = ?
                )
            </value>
        </property>

    </bean>
    
    <bean class="com.softwareplumbers.dms.rest.server.sql.Templates" scope="singleton">
        <property name="FetchDocumentLinkByPath">
            <value>
            SELECT 
                !{1}.ID, 
                !{1}.PARENT_ID,
                !{1}.NAME,
                !{1}.DELETED, 
                !{1}.VERSIONED, 
                !{1}.DOCUMENT_ID, 
                !{1}.DOCUMENT_VERSION,
                !{1}.DOCUMENT_CREATED,
                !{1}.MEDIA_TYPE,
                !{1}.LENGTH,
                !{1}.DIGEST,
                !{1}.METADATA,
                !{0} AS PATH
            FROM
                VIEW_LINKS !{1} !{2} 
            WHERE N1.PARENT_ID = ? !{3}
            </value>
        </property>
        <property name="FetchFolderByPath">
            <value>
            SELECT 
                !{1}.ID, 
                !{1}.PARENT_ID,
                !{1}.NAME,
                !{1}.DELETED, 
                !{1}.STATE,
                !{1}.METADATA,
                !{0} AS PATH
            FROM
                VIEW_FOLDERS !{1} !{2} 
            WHERE N1.PARENT_ID = ? !{3}
            </value>
        </property>
        <property name="FetchInfoByPath">
            <value>
                SELECT 
                    !{1}.ID, 
                    !{1}.PARENT_ID,
                    !{1}.NAME,
                    !{1}.DELETED, 
                    !{1}.TYPE,
                    !{0} AS PATH
                FROM
                    NODES !{1} !{2} 
                WHERE N1.PARENT_ID = ? !{3}
            </value>
        </property>
        <property name="JoinParentNode" value="INNER JOIN NODES !{1} ON !{0}.PARENT_ID = !{1}.ID !{2}"/>
        <property name="NameWhereClause" value="AND !{0}.NAME = ? !{1}"/>
        <property name="FetchDocumentLinkByPathAndId">
            <value>
            SELECT 
                ID, 
                PARENT_ID,
                NAME,
                DELETED, 
                VERSIONED, 
                DOCUMENT_ID, 
                DOCUMENT_VERSION,
                DOCUMENT_CREATED,
                MEDIA_TYPE,
                LENGTH,
                DIGEST,
                METADATA,
                !{0} || '/' || NAME AS PATH
            FROM
                VIEW_LINKS
            INNER JOIN (!{1}) ON VIEW_LINKS.PARENT_ID = !{2}.ID 
            WHERE (!{3}) AND VIEW_LINKS.DOCUMENT_ID = ?         
            </value>   
        </property>
    </bean>

</beans>